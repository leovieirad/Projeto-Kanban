{% extends "boards/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">

    <h1>{{ board.title }}</h1>
    <p>{{ board.description }}</p>

    <!-- As colunas s√£o fixas: A Fazer / Em Progresso / Feito. A cria√ß√£o de novas colunas foi desabilitada. -->

    <!-- A√ß√µes do quadro -->
    <div style="display:flex;gap:10px;margin-bottom:12px;align-items:center;">
        <button id="btn-edit-board" class="btn btn-primary" style="min-width: 140px;">Editar quadro</button>
        <button id="btn-add-new-column" class="btn btn-success" style="min-width: 140px;">Nova coluna</button>
        <form method="post" action="{% url 'boards:delete_board' board.id %}" onsubmit="return confirm('Deseja realmente excluir este quadro?');" style="margin:0;">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger btn-primary" style="min-width: 140px;">Excluir quadro</button>
        </form>
    </div>

    <!-- Formul√°rio escondido -->
    <div id="edit-board-form" style="display: none;">
        <form method="POST" action="{% url 'boards:update_board' board.id %}">
            {% csrf_token %}
            {% if board_form %}
                {{ board_form.as_p }}
            {% else %}
                <div class="mb-2">
                    <label for="id_title" class="form-label">üìå T√≠tulo do Quadro</label>
                    <input type="text" name="title" id="id_title" class="form-control" value="{{ board.title }}" placeholder="Digite o t√≠tulo do quadro" required>
                </div>
                <div class="mb-2">
                    <label for="id_description" class="form-label">üìù Descri√ß√£o</label>
                    <textarea name="description" id="id_description" class="form-control" placeholder="Descreva o prop√≥sito deste quadro...">{{ board.description }}</textarea>
                </div>
            {% endif %}
            <button type="submit" class="btn btn-success">üíæ Salvar altera√ß√µes</button>
        </form>
        <hr>
    </div>

    <!-- Formul√°rio de Nova Coluna -->
    <div id="new-column-form" style="display: none; margin-bottom: 20px; padding: 12px; background: rgba(0,0,0,0.1); border-radius: 8px;">
        <form method="POST" action="{% url 'boards:create_column' board.id %}" style="display: flex; flex-direction: column; gap: 10px;">
            {% csrf_token %}
            <input type="text" name="title" class="form-control" placeholder="Nome da nova coluna" required style="padding: 8px; border-radius: 6px;">
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button type="button" class="btn btn-sm" onclick="toggleNewColumnForm()" style="background: transparent; color: var(--muted); border: 1px solid #ccc;">Cancelar</button>
                <button type="submit" class="btn btn-success btn-sm">Criar coluna</button>
            </div>
        </form>
    </div>

    <div class="board-columns">
        {% for c in kanban_columns %}
        <div class="board-column {{ c.class_name }}" draggable="true" data-column-id="{{ c.column.id }}" data-column-key="{{ c.key }}">
            <div class="col-header {{ c.class_name }}">
                <span>{{ c.display_name }}</span>
                <button type="button" class="btn-delete-column" onclick="deleteColumn({{ c.column.id }})" title="Deletar coluna">
                    ‚úï
                </button>
            </div>

            <div class="kanban-list" data-column-key="{{ c.key }}">
                {% if c.cards %}
                    {% for card in c.cards %}
                    <div class="kanban-card" draggable="true" data-card-id="{{ card.id }}" data-column-key="{{ c.key }}" onclick="openCardModal({{ card.id }}, '{{ card.title|escapejs }}', '{{ card.description|escapejs }}', {{ card.column.board.id }}, '{{ c.class_name }}')" style="cursor: pointer;">
                        <div class="card-title"><strong>{{ card.title }}</strong></div>
                        {% if card.description %}
                        <div class="card-desc">{{ card.description|truncatewords:15 }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    <button class="btn btn-primary full-width" style="margin-top: 10px;" onclick="toggleNewCardForm({{ c.column.id }})">+ Adicionar cart√£o</button>
                {% else %}
                    <div class="card-empty"><i>Nenhum cart√£o.</i></div>
                    <button class="btn btn-primary full-width" style="margin-top: 10px;" onclick="toggleNewCardForm({{ c.column.id }})">+ Adicionar cart√£o</button>
                {% endif %}
            </div>
            <div id="new-card-{{ c.column.id }}" style="display:none; margin-top:8px; padding:12px; background: rgba(0,0,0,0.1); border-radius:8px;">
                <form method="POST" action="{% url 'boards:create_card' c.column.id %}" onsubmit="return validateCardTitle(this)" style="display: flex; flex-direction: column; gap: 10px;">
                    {% csrf_token %}
                    <input type="text" name="title" class="form-control" placeholder="T√≠tulo do cart√£o" required style="padding: 8px; border-radius: 6px;">
                    <textarea name="description" class="form-control" placeholder="Descri√ß√£o (opcional)" style="padding: 8px; border-radius: 6px; min-height: 60px; resize: vertical;"></textarea>
                    <div style="display: flex; gap: 8px; justify-content: flex-end;">
                        <button type="button" class="btn btn-sm" onclick="toggleNewCardForm({{ c.column.id }})" style="background: transparent; color: var(--muted); border: 1px solid #ccc;">Cancelar</button>
                        <button type="submit" class="btn btn-success btn-sm">Criar</button>
                    </div>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>

</div>

<!-- Modal de Detalhes do Card (estilo Trello) -->
<div class="card-modal-overlay" id="cardModal" onclick="closeCardModalOnOverlay(event)">
    <div class="card-modal" onclick="event.stopPropagation()">
        <div class="card-modal-header">
            <span class="card-modal-icon">üìã</span>
            <h2 class="card-modal-title" id="modalCardTitle"></h2>
            <button class="card-modal-close" onclick="closeCardModal()" type="button">
                ‚úï
            </button>
        </div>
        <div class="card-modal-body">
            <div class="card-modal-section">
                <div class="card-modal-section-title">
                    <span>üìù</span>
                    Descri√ß√£o
                </div>
                <div class="card-modal-description" id="modalCardDescription"></div>
            </div>
            
            <div class="card-modal-section">
                <div class="card-modal-section-title">
                    <span>‚ö°</span>
                    A√ß√µes
                </div>
                <div class="card-modal-actions">
                    <button class="card-modal-btn" onclick="toggleEditForm()" type="button">
                        ‚úèÔ∏è Editar
                    </button>
                    <button class="card-modal-btn danger" onclick="deleteCard()" type="button">
                        üóëÔ∏è Excluir
                    </button>
                </div>
                
                <!-- Form de edi√ß√£o (escondido por padr√£o) -->
                <div class="card-modal-edit-form" id="editForm">
                    <form method="POST" id="cardEditForm" onsubmit="return submitCardEdit(event)">
                        {% csrf_token %}
                        <input type="text" name="title" id="editTitle" placeholder="T√≠tulo do cart√£o" required>
                        <textarea name="description" id="editDescription" placeholder="Descri√ß√£o (opcional)"></textarea>
                        <div class="btn-group">
                            <button type="submit" class="btn-save">Salvar</button>
                            <button type="button" class="btn-cancel" onclick="toggleEditForm()">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentCardId = null;
let currentBoardId = null;
let currentColumnClass = null;

// Fun√ß√£o para obter CSRF Token (dispon√≠vel globalmente)
function getCsrfToken() {
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    return getCookie('csrftoken');
}

// Notifica√ß√£o flutuante simples para feedback de requisi√ß√µes AJAX
function showToast(message, type) {
    try {
        let container = document.querySelector('.floating-toast');
        if (!container) {
            container = document.createElement('div');
            container.className = 'floating-toast';
            document.body.appendChild(container);
        }
        const item = document.createElement('div');
        item.className = 'toast-item ' + (type || '');
        item.textContent = message;
        container.appendChild(item);
        setTimeout(() => { item.style.opacity = '0'; setTimeout(()=> item.remove(), 400); }, 2400);
    } catch(e) { console.warn('toast fail', e); }
}

function openCardModal(cardId, title, description, boardId, columnClass) {
    event.stopPropagation();
    currentCardId = cardId;
    currentBoardId = boardId;
    
    // Detectar dinamicamente em qual coluna o card est√° agora e pegar a classe de cor
    const cardElement = document.querySelector(`[data-card-id="${cardId}"]`);
    if (cardElement) {
        const boardColumn = cardElement.closest('.board-column');
        if (boardColumn) {
            // Pegar a classe que come√ßa com 'col-'
            const classes = boardColumn.className.split(' ');
            currentColumnClass = classes.find(cls => cls.startsWith('col-')) || columnClass;
        } else {
            currentColumnClass = columnClass;
        }
    } else {
        currentColumnClass = columnClass;
    }
    
    document.getElementById('modalCardTitle').textContent = title;
    
    const descElement = document.getElementById('modalCardDescription');
    if (description && description.trim()) {
        descElement.textContent = description;
        descElement.classList.remove('empty');
    } else {
        descElement.textContent = 'Sem descri√ß√£o';
        descElement.classList.add('empty');
    }
    
    // Preencher form de edi√ß√£o
    document.getElementById('editTitle').value = title;
    document.getElementById('editDescription').value = description;
    document.getElementById('editForm').classList.remove('active');
    
    // Aplicar cor ao bot√£o de salvar baseado na coluna onde o card est√° agora
    applyColumnColorToSaveButton(currentColumnClass);
    
    document.getElementById('cardModal').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function applyColumnColorToSaveButton(columnClass) {
    const saveBtn = document.querySelector('.btn-save');
    // Remover todas as classes de cor
    saveBtn.classList.remove('save-afazer', 'save-progress', 'save-feito', 
                            'save-color-1', 'save-color-2', 'save-color-3', 'save-color-4',
                            'save-color-5', 'save-color-6', 'save-color-7', 'save-color-8');
    
    // Extrair a classe de cor do columnClass (ex: col-afazer, col-progress, col-color-1)
    if (columnClass.includes('col-afazer')) {
        saveBtn.classList.add('save-afazer');
    } else if (columnClass.includes('col-progress')) {
        saveBtn.classList.add('save-progress');
    } else if (columnClass.includes('col-feito')) {
        saveBtn.classList.add('save-feito');
    } else if (columnClass.includes('col-color-')) {
        // Para colunas din√¢micas (col-color-X)
        const colorMatch = columnClass.match(/col-color-(\d+)/);
        if (colorMatch) {
            const colorNum = colorMatch[1];
            saveBtn.classList.add(`save-color-${colorNum}`);
        }
    }
}

function closeCardModal() {
    document.getElementById('cardModal').classList.remove('active');
    document.body.style.overflow = '';
    currentCardId = null;
    currentBoardId = null;
}

function closeCardModalOnOverlay(event) {
    if (event.target.id === 'cardModal') {
        closeCardModal();
    }
}

function toggleEditForm() {
    const form = document.getElementById('editForm');
    form.classList.toggle('active');
}

function submitCardEdit(event) {
    event.preventDefault();
    const form = document.getElementById('cardEditForm');
    form.action = `/card/${currentCardId}/edit/`;
    form.submit();
    return false;
}

function deleteCard() {
    if (!confirm('Tem certeza que deseja excluir este cart√£o?')) return;
    
    // Construir a URL manualmente baseada no padr√£o de URL do Django
    const url = `/cartoes/${currentCardId}/delete/`;
    
    console.log('Deletando card ID:', currentCardId, 'URL:', url);
    
    fetch(url, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
        }
    }).then(response => {
        console.log('Response status:', response.status);
        if (response.ok) {
            return response.json().then(data => {
                console.log('Delete response:', data);
                
                // Remover o cart√£o do DOM instantaneamente
                const cardElement = document.querySelector(`[data-card-id="${currentCardId}"]`);
                if (cardElement) {
                    cardElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    cardElement.style.opacity = '0';
                    cardElement.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        cardElement.remove();
                    }, 300);
                }
                
                // Mostrar notifica√ß√£o
                showToast('Cart√£o exclu√≠do com sucesso', 'success');
                
                // Fechar o modal
                closeCardModal();
            });
        } else {
            return response.text().then(text => {
                console.error('Error response:', text);
                showToast('Erro ao excluir cart√£o. Status: ' + response.status, 'error');
            });
        }
    }).catch(error => {
        console.error('Erro ao excluir:', error);
        showToast('Erro ao excluir cart√£o: ' + error.message, 'error');
    });
}

function deleteColumn(columnId) {
    if (!confirm('Tem certeza que deseja excluir esta coluna? Todos os cart√µes ser√£o deletados.')) return;
    
    const url = `/colunas/${columnId}/delete/`;
    
    fetch(url, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
        }
    }).then(response => {
        if (response.ok) {
            return response.json().then(data => {
                if (data.ok) {
                    // Remover a coluna do DOM instantaneamente
                    const columnElement = document.querySelector(`[data-column-id="${columnId}"]`);
                    if (columnElement) {
                        columnElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                        columnElement.style.opacity = '0';
                        columnElement.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            columnElement.remove();
                        }, 300);
                    }
                    
                    showToast('Coluna exclu√≠da com sucesso', 'success');
                } else {
                    showToast(data.error || 'Erro ao excluir coluna', 'error');
                }
            });
        } else {
            return response.json().then(data => {
                showToast(data.error || 'Erro ao excluir coluna', 'error');
            }).catch(() => {
                showToast('Erro ao excluir coluna', 'error');
            });
        }
    }).catch(error => {
        console.error('Erro:', error);
        showToast('Erro ao excluir coluna: ' + error.message, 'error');
    });
}

// Fechar modal com tecla ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('cardModal').classList.contains('active')) {
        closeCardModal();
    }
});

document.addEventListener('DOMContentLoaded', function () {
    const btnEdit = document.getElementById("btn-edit-board");
    const editForm = document.getElementById("edit-board-form");
    if (btnEdit && editForm) {
        btnEdit.addEventListener('click', function (e) {
            e.preventDefault();
            if (editForm.style.display === "none" || editForm.style.display === "") {
                editForm.style.display = "block";
            } else {
                editForm.style.display = "none";
            }
            const firstInput = editForm.querySelector('input, textarea');
            if (firstInput && editForm.style.display === "block") firstInput.focus();
        });
    }

    // Nova Coluna toggle
    const btnAddColumn = document.getElementById("btn-add-new-column");
    const newColumnForm = document.getElementById("new-column-form");
    if (btnAddColumn && newColumnForm) {
        btnAddColumn.addEventListener('click', function (e) {
            e.preventDefault();
            if (newColumnForm.style.display === "none" || newColumnForm.style.display === "") {
                newColumnForm.style.display = "block";
            } else {
                newColumnForm.style.display = "none";
            }
            const firstInput = newColumnForm.querySelector('input');
            if (firstInput && newColumnForm.style.display === "block") firstInput.focus();
        });
    }
    window.toggleNewColumnForm = function() {
        const form = document.getElementById("new-column-form");
        form.style.display = form.style.display === "none" || form.style.display === "" ? "block" : "none";
    };

    window.toggleNewCardForm = function(id) {
        let div = document.getElementById("new-card-" + id);
        if (!div) return;
        div.style.display = div.style.display === "none" || div.style.display === "" ? "block" : "none";
    };

    // Comportamento de arrastar e soltar (arrastar e soltar)
    let dragged = null;

    function onDragStart(e) {
        dragged = e.currentTarget;
        dragged.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', dragged.dataset.cardId);
        e.stopPropagation(); // Impedir que o evento chegue √† coluna
    }

    function onDragEnd(e) {
        if (dragged) dragged.classList.remove('dragging');
        dragged = null;
        e.stopPropagation(); // Impedir que o evento chegue √† coluna
    }

    function onDragOverList(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('drop-target');
    }

    function onDragLeaveList(e) {
        this.classList.remove('drop-target');
    }

    function onDropList(e) {
        e.preventDefault();
        this.classList.remove('drop-target');
        const cardId = e.dataTransfer.getData('text/plain');
        const cardElem = document.querySelector('[data-card-id="' + cardId + '"]');
        if (!cardElem) return;
        // Anexa ao destino do drop (final)
        this.appendChild(cardElem);
        saveBoardOrder();
    }

    function attachDnD() {
        document.querySelectorAll('.kanban-card').forEach(function(card){
            card.removeEventListener('dragstart', onDragStart);
            card.removeEventListener('dragend', onDragEnd);
            card.addEventListener('dragstart', onDragStart);
            card.addEventListener('dragend', onDragEnd);
        });

        document.querySelectorAll('.kanban-list').forEach(function(list){
            list.removeEventListener('dragover', onDragOverList);
            list.removeEventListener('dragleave', onDragLeaveList);
            list.removeEventListener('drop', onDropList);
            list.addEventListener('dragover', onDragOverList);
            list.addEventListener('dragleave', onDragLeaveList);
            list.addEventListener('drop', onDropList);
        });

        // Drag-and-drop para colunas
        document.querySelectorAll('.board-column').forEach(function(col){
            col.removeEventListener('dragstart', onColumnDragStart);
            col.removeEventListener('dragend', onColumnDragEnd);
            col.removeEventListener('dragover', onColumnDragOver);
            col.removeEventListener('dragleave', onColumnDragLeave);
            col.removeEventListener('drop', onColumnDrop);
            col.addEventListener('dragstart', onColumnDragStart);
            col.addEventListener('dragend', onColumnDragEnd);
            col.addEventListener('dragover', onColumnDragOver);
            col.addEventListener('dragleave', onColumnDragLeave);
            col.addEventListener('drop', onColumnDrop);
        });
    }

    // Vari√°vel global para controlar qual coluna est√° sendo arrastada
    let draggedColumn = null;

    function onColumnDragStart(e) {
        // Verificar se estamos arrastando um card, n√£o a coluna
        if (e.target.classList.contains('kanban-card') || e.target.closest('.kanban-card')) {
            return;
        }
        
        draggedColumn = e.currentTarget;
        draggedColumn.classList.add('dragging-column');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', draggedColumn.dataset.columnId);
    }

    function onColumnDragEnd(e) {
        // Verificar se estamos arrastando um card, n√£o a coluna
        if (e.target.classList.contains('kanban-card') || e.target.closest('.kanban-card')) {
            return;
        }
        
        if (draggedColumn) {
            draggedColumn.classList.remove('dragging-column');
            // Remover classe de drop target de todas as colunas
            document.querySelectorAll('.board-column').forEach(col => {
                col.classList.remove('drop-target-column');
            });
        }
        draggedColumn = null;
    }

    function onColumnDragOver(e) {
        if (!draggedColumn || this === draggedColumn) return;
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('drop-target-column');
    }

    function onColumnDragLeave(e) {
        if (e.target === this) {
            this.classList.remove('drop-target-column');
        }
    }

    function onColumnDrop(e) {
        e.preventDefault();
        if (!draggedColumn || this === draggedColumn) {
            this.classList.remove('drop-target-column');
            return;
        }
        
        this.classList.remove('drop-target-column');

        // Trocar as colunas de posi√ß√£o
        const boardColumns = document.querySelector('.board-columns');
        const allColumns = Array.from(boardColumns.querySelectorAll('.board-column'));
        
        const draggedIndex = allColumns.indexOf(draggedColumn);
        const targetIndex = allColumns.indexOf(this);
        
        if (draggedIndex > targetIndex) {
            this.parentNode.insertBefore(draggedColumn, this);
        } else {
            this.parentNode.insertBefore(draggedColumn, this.nextSibling);
        }
        
        saveBoardColumnOrder();
    }

    function saveBoardOrder() {
        const columns = [];
        document.querySelectorAll('.board-column').forEach(function(col){
            const colId = parseInt(col.dataset.columnId);
            if (isNaN(colId) || colId <= 0) return; // ignorar colunas sem id real
            const cards = [];
            col.querySelectorAll('.kanban-card').forEach(function(card){
                cards.push(parseInt(card.dataset.cardId));
            });
            columns.push({id: colId, cards: cards});
        });

        const url = "{% url 'boards:reorder_cards' %}";
        fetch(url, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            },
            body: JSON.stringify({columns: columns})
        }).then(resp => resp.json())
          .then(data => {
              if (data && data.ok) {
                  showToast('Ordem salva', 'success');
              } else {
                  showToast('Falha ao salvar ordem', 'error');
                  console.warn('reorder failed', data);
              }
          }).catch(err => {
              showToast('Erro de rede ao salvar', 'error');
              console.error(err);
          });
    }

    function saveBoardColumnOrder() {
        const columns = [];
        document.querySelectorAll('.board-column').forEach(function(col){
            const colId = parseInt(col.dataset.columnId);
            if (isNaN(colId) || colId <= 0) return; // ignorar colunas sem id real
            columns.push(colId);
        });

        const url = "{% url 'boards:reorder_columns' %}";
        fetch(url, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            },
            body: JSON.stringify({columns: columns})
        }).then(resp => resp.json())
          .then(data => {
              if (data && data.ok) {
                  showToast('Coluna movida com sucesso', 'success');
              } else {
                  showToast('Falha ao mover coluna', 'error');
                  console.warn('reorder columns failed', data);
              }
          }).catch(err => {
              showToast('Erro de rede ao mover coluna', 'error');
              console.error(err);
          });
    }

    // Anexar eventos de arrastar/soltar ap√≥s renderiza√ß√£o inicial
    attachDnD();
});

// Validar que o t√≠tulo do cart√£o n√£o est√° vazio
function validateCardTitle(form) {
    const titleInput = form.querySelector('input[name="title"]');
    if (!titleInput.value.trim()) {
        alert('Por favor, informe um t√≠tulo para o cart√£o');
        titleInput.focus();
        return false;
    }
    return true;
}
</script>

{% endblock %}
