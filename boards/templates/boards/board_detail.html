{% extends "boards/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">

    <h1>{{ board.title }}</h1>
    <p>{{ board.description }}</p>

    <!-- Criar nova coluna -->
    <div style="margin:12px 0;">
        <form method="POST" action="{% url 'boards:create_column' board.id %}" style="display:flex;gap:8px;align-items:center;max-width:480px;">
            {% csrf_token %}
            <input type="text" name="title" placeholder="Nova coluna (ex: To Do)" class="form-control" style="flex:1;"/>
            <button type="submit" class="btn btn-secondary">Criar coluna</button>
        </form>
    </div>

    <!-- Botão Editar Quadro -->
    <button id="btn-edit-board" class="btn btn-primary mb-3">
        Editar quadro
    </button>

    <!-- Formulário escondido -->
    <div id="edit-board-form" style="display: none;">
        <form method="POST" action="{% url 'boards:update_board' board.id %}">
            {% csrf_token %}
            {% if board_form %}
                {{ board_form.as_p }}
            {% else %}
                <div class="mb-2">
                    <label for="id_title" class="form-label">Título</label>
                    <input type="text" name="title" id="id_title" class="form-control" value="{{ board.title }}">
                </div>
                <div class="mb-2">
                    <label for="id_description" class="form-label">Descrição</label>
                    <textarea name="description" id="id_description" class="form-control">{{ board.description }}</textarea>
                </div>
            {% endif %}
            <button type="submit" class="btn btn-success">Salvar alterações</button>
        </form>
        <hr>
    </div>

    <div class="board-columns">
        {% for column in board.columns.all %}
        <div class="board-column" data-column-id="{{ column.id }}">
            <h4>{{ column.title }}</h4>

            <div class="kanban-list" data-column-id="{{ column.id }}">
                {% for card in column.cards.all %}
                <div class="kanban-card" draggable="true" data-card-id="{{ card.id }}">
                    <div class="card-title"><strong>{{ card.title }}</strong></div>
                    <div class="card-desc">{{ card.description }}</div>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-link" onclick="toggleCardForm({{ card.id }})">Editar</button>
                    </div>

                    <div id="card-form-{{ card.id }}" style="display:none; margin-top:8px;">
                        <form method="POST" action="{% url 'boards:edit_card' card.id %}">
                            {% csrf_token %}
                            <input type="text" name="title" value="{{ card.title }}" class="form-control mb-2">
                            <textarea name="description" class="form-control mb-2">{{ card.description }}</textarea>
                            <button type="submit" class="btn btn-success btn-sm">Salvar</button>
                        </form>
                    </div>
                </div>
                {% empty %}
                <div class="card-empty"><i>Nenhum cartão.</i></div>
                {% endfor %}
            </div>

            <button class="btn btn-primary full-width" onclick="toggleNewCardForm({{ column.id }})">+ Adicionar cartão</button>
            <div id="new-card-{{ column.id }}" style="display:none; margin-top:8px;">
                <form method="POST" action="{% url 'boards:create_card' column.id %}">
                    {% csrf_token %}
                    <input type="text" name="title" class="form-control mb-2" placeholder="Título do cartão">
                    <textarea name="description" class="form-control mb-2" placeholder="Descrição"></textarea>
                    <button type="submit" class="btn btn-success btn-sm">Criar</button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const btnEdit = document.getElementById("btn-edit-board");
    const editForm = document.getElementById("edit-board-form");
    if (btnEdit && editForm) {
        btnEdit.addEventListener('click', function (e) {
            e.preventDefault();
            if (editForm.style.display === "none" || editForm.style.display === "") {
                editForm.style.display = "block";
            } else {
                editForm.style.display = "none";
            }
            const firstInput = editForm.querySelector('input, textarea');
            if (firstInput && editForm.style.display === "block") firstInput.focus();
        });
    }

    window.toggleCardForm = function(id) {
        let div = document.getElementById("card-form-" + id);
        if (!div) return;
        div.style.display = div.style.display === "none" || div.style.display === "" ? "block" : "none";
    };

    window.toggleNewCardForm = function(id) {
        let div = document.getElementById("new-card-" + id);
        if (!div) return;
        div.style.display = div.style.display === "none" || div.style.display === "" ? "block" : "none";
    };

    // Comportamento de arrastar e soltar (Drag and Drop)
    let dragged = null;

    function onDragStart(e) {
        dragged = e.currentTarget;
        dragged.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', dragged.dataset.cardId);
    }

    function onDragEnd(e) {
        if (dragged) dragged.classList.remove('dragging');
        dragged = null;
    }

    function onDragOverList(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('drop-target');
    }

    function onDragLeaveList(e) {
        this.classList.remove('drop-target');
    }

    function onDropList(e) {
        e.preventDefault();
        this.classList.remove('drop-target');
        const cardId = e.dataTransfer.getData('text/plain');
        const cardElem = document.querySelector('[data-card-id="' + cardId + '"]');
        if (!cardElem) return;
        // Append at drop target (end)
        this.appendChild(cardElem);
        saveBoardOrder();
    }

    function attachDnD() {
        document.querySelectorAll('.kanban-card').forEach(function(card){
            card.removeEventListener('dragstart', onDragStart);
            card.removeEventListener('dragend', onDragEnd);
            card.addEventListener('dragstart', onDragStart);
            card.addEventListener('dragend', onDragEnd);
        });

        document.querySelectorAll('.kanban-list').forEach(function(list){
            list.removeEventListener('dragover', onDragOverList);
            list.removeEventListener('dragleave', onDragLeaveList);
            list.removeEventListener('drop', onDropList);
            list.addEventListener('dragover', onDragOverList);
            list.addEventListener('dragleave', onDragLeaveList);
            list.addEventListener('drop', onDropList);
        });
    }

    // Save order via AJAX
    function getCsrfToken() {
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        return getCookie('csrftoken');
    }

    function saveBoardOrder() {
        const columns = [];
        document.querySelectorAll('.board-column').forEach(function(col){
            const colId = parseInt(col.dataset.columnId);
            const cards = [];
            col.querySelectorAll('.kanban-card').forEach(function(card){
                cards.push(parseInt(card.dataset.cardId));
            });
            columns.push({id: colId, cards: cards});
        });

        const url = "{% url 'boards:reorder_cards' %}";
        fetch(url, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            },
            body: JSON.stringify({columns: columns})
        }).then(resp => resp.json())
          .then(data => {
              if (data && data.ok) {
                  showToast('Ordem salva', 'success');
              } else {
                  showToast('Falha ao salvar ordem', 'error');
                  console.warn('reorder failed', data);
              }
          }).catch(err => {
              showToast('Erro de rede ao salvar', 'error');
              console.error(err);
          });
    }

    // Simple floating toast for AJAX feedback
    function showToast(message, type) {
        try {
            let container = document.querySelector('.floating-toast');
            if (!container) {
                container = document.createElement('div');
                container.className = 'floating-toast';
                document.body.appendChild(container);
            }
            const item = document.createElement('div');
            item.className = 'toast-item ' + (type || '');
            item.textContent = message;
            container.appendChild(item);
            setTimeout(() => { item.style.opacity = '0'; setTimeout(()=> item.remove(), 400); }, 2400);
        } catch(e) { console.warn('toast fail', e); }
    }

    // Attach DnD after initial render
    attachDnD();
});
</script>

{% endblock %}
