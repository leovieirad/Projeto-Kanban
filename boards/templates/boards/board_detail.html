{% extends "boards/base.html" %}

{% block content %}

<style>
  .card.done {
    opacity: 0.6;
    text-decoration: line-through;
  }
</style>
  
  <h1>{{ board.title }}</h1>
  <p class="small">{{ board.description }}</p>

  <h2>Colunas</h2>
  <div class="flex">
    {% for column in board.columns.all %}
      <div class="column">
        <h3>{{ column.title }}</h3>
        <ul>
          {% for card in column.cards.all %}
            <li class="card" data-card-id="{{ card.pk }}">
              <label>
                <input type="checkbox" class="toggle-done" {% if card.is_done %}checked{% endif %}>
                <strong>{{ card.title }}</strong>
              </label>
              {% if card.is_done %}✓{% endif %}
              <div class="small">{{ card.description }}</div>
            </li>
          {% empty %}
            <li class="small">Nenhum cartão.</li>
          {% endfor %}
        </ul>
        <!-- form rápido para criar cartão -->
        <form method="post" action="{% url 'boards:create_card' column.pk %}">
          {% csrf_token %}
          <input name="title" placeholder="Título do cartão" class="input" required />
          <input type="hidden" name="position" value="{{ column.cards.count }}" />
          <button type="submit" class="btn">+ Novo cartão</button>
        </form>
        <form method="post" action="{% url 'boards:update_board' board.pk %}" style="margin-bottom:16px;">
          {% csrf_token %}
          <div style="display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap;">
            <div style="flex:1;">
              <input name="title" value="{{ board.title }}" class="input" style="font-size:1.5rem; font-weight:600; width:100%;" required />
            </div>
            <div style="flex:2;">
              <textarea name="description" class="input" placeholder="Descrição" style="width:100%; height:60px;">{{ board.description }}</textarea>
            </div>
            <div>
              <button type="submit" class="btn">Salvar</button>
            </div>
          </div>
        </form>
      </div>
    {% empty %}
      <p>Sem colunas ainda.</p>
    {% endfor %}

    <!-- adicionar coluna -->
    <div class="column">
      <h3>+ Adicionar coluna</h3>
      <form method="post" action="{% url 'boards:create_column' board.pk %}">
        {% csrf_token %}
        <input name="title" placeholder="Título da coluna" class="input" required />
        <input type="hidden" name="position" value="{{ board.columns.count }}" />
        <button type="submit" class="btn">Adicionar</button>
      </form>
    </div>
  </div>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie("csrftoken");

  document.querySelectorAll(".toggle-done").forEach((checkbox) => {
    checkbox.addEventListener("change", async (e) => {
      const li = e.target.closest("li.card");
      const cardId = li.dataset.cardId;
      try {
        const resp = await fetch(
          `{% url 'boards:toggle_card_done' 0 %}`.replace("/0/", `/${cardId}/`),
          {
            method: "POST",
            headers: {
              "X-CSRFToken": csrftoken,
              Accept: "application/json",
            },
          }
        );
        const data = await resp.json();
        // <-- aqui é onde vai esse if/else
        if (data.is_done) {
          li.classList.add("done");
        } else {
          li.classList.remove("done");
        }
      } catch (err) {
        console.error("Erro toggle card:", err);
      }
    });
  });
</script>


{% endblock %}
