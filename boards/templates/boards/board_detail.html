{% extends "boards/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">

    <h1>{{ board.title }}</h1>
    <p>{{ board.description }}</p>

    <!-- Botão Editar Quadro -->
    <button id="btn-edit-board" class="btn btn-primary mb-3">
        Editar quadro
    </button>

    <!-- Formulário escondido -->
    <div id="edit-board-form" style="display: none;">
        <form method="POST">
            {% csrf_token %}
            {% if board_form %}
                {{ board_form.as_p }}
            {% else %}
                <div class="mb-2">
                    <label for="id_title" class="form-label">Título</label>
                    <input type="text" name="title" id="id_title" class="form-control" value="{{ board.title }}">
                </div>
                <div class="mb-2">
                    <label for="id_description" class="form-label">Descrição</label>
                    <textarea name="description" id="id_description" class="form-control">{{ board.description }}</textarea>
                </div>
            {% endif %}
            <button type="submit" class="btn btn-success">Salvar alterações</button>
        </form>
        <hr>
    </div>

    <div class="row">
        {% for column in board.columns.all %}
        <div class="col-md-4 mb-4">
            <div class="card p-3">

                <h4>{{ column.title }}</h4>

                <!-- Lista de cartões -->
                <ul>
                    {% for card in column.cards.all %}
                        <li>
                            <strong>{{ card.title }}</strong>
                            <br>
                            {{ card.description }}

                            <!-- Botão editar cartão -->
                            <button class="btn btn-sm btn-link text-primary"
                                onclick="toggleCardForm({{ card.id }})">
                                Editar
                            </button>

                            <!-- Form edit card (hidden) -->
                            <div id="card-form-{{ card.id }}" style="display:none;">
                                <form method="POST" action="{% url 'boards:edit_card' card.id %}">
                                    {% csrf_token %}
                                    <input type="text" name="title" value="{{ card.title }}" class="form-control mb-2">
                                    <textarea name="description" class="form-control mb-2">{{ card.description }}</textarea>
                                    <button type="submit" class="btn btn-success btn-sm">Salvar</button>
                                </form>
                                <hr>
                            </div>

                        </li>
                    {% empty %}
                        <li><i>Nenhum cartão.</i></li>
                    {% endfor %}
                </ul>

                <!-- Botão adicionar cartão -->
                <button class="btn btn-sm btn-primary"
                        onclick="toggleNewCardForm({{ column.id }})">
                    + Adicionar cartão
                </button>

                <!-- Form novo cartão (hidden) -->
                <div id="new-card-{{ column.id }}" style="display:none;" class="mt-2">
                    <form method="POST" action="{% url 'boards:create_card' column.id %}">
                        {% csrf_token %}
                        <input type="text" name="title" class="form-control mb-2" placeholder="Título do cartão">
                        <textarea name="description" class="form-control mb-2" placeholder="Descrição"></textarea>
                        <button type="submit" class="btn btn-success btn-sm">Criar</button>
                    </form>
                </div>

            </div>
        </div>
        {% endfor %}
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const btnEdit = document.getElementById("btn-edit-board");
    const editForm = document.getElementById("edit-board-form");
    if (btnEdit && editForm) {
        btnEdit.addEventListener('click', function (e) {
            e.preventDefault();
            if (editForm.style.display === "none" || editForm.style.display === "") {
                editForm.style.display = "block";
            } else {
                editForm.style.display = "none";
            }
            const firstInput = editForm.querySelector('input, textarea');
            if (firstInput && editForm.style.display === "block") firstInput.focus();
        });
    }

    window.toggleCardForm = function(id) {
        let div = document.getElementById("card-form-" + id);
        if (!div) return;
        div.style.display = div.style.display === "none" || div.style.display === "" ? "block" : "none";
    };

    window.toggleNewCardForm = function(id) {
        let div = document.getElementById("new-card-" + id);
        if (!div) return;
        div.style.display = div.style.display === "none" || div.style.display === "" ? "block" : "none";
    };
});
</script>

{% endblock %}
