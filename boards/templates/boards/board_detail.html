{% extends "boards/base.html" %}

{% block content %}
<div class="board-container">
  <!-- Título e descrição -->
  <header class="board-header">
    <h1 class="board-title">{{ board.title }}</h1>
    <p class="board-description">{{ board.description }}</p>
  </header>

  <!-- Form para editar quadro -->
  <section class="board-edit">
    <form method="post" action="{% url 'boards:update_board' board.pk %}">
      {% csrf_token %}
      <div class="form-group">
        <input name="title" value="{{ board.title }}" class="input" required />
      </div>
      <div class="form-group">
        <textarea name="description" class="input" placeholder="Descrição">{{ board.description }}</textarea>
      </div>
      <div class="form-group">
        <button type="submit" class="btn">Salvar</button>
      </div>
    </form>
  </section>

  <!-- Colunas -->
  <section class="board-columns">
    <div class="columns-container">
      {% for column in board.columns.all %}
        <div class="kanban-column">
          <h3 class="column-title">{{ column.title }}</h3>
          <ul class="cards-list">
            {% for card in column.cards.all %}
              <li class="card {% if card.is_done %}done{% endif %}" data-card-id="{{ card.pk }}">
                <label>
                  <input type="checkbox" class="toggle-done" {% if card.is_done %}checked{% endif %}>
                  <span class="card-title">{{ card.title }}</span>
                </label>
                <p class="card-description">{{ card.description }}</p>
              </li>
            {% empty %}
              <li class="card empty">Nenhum cartão.</li>
            {% endfor %}
          </ul>

          <!-- Form rápido para criar cartão -->
          <form method="post" action="{% url 'boards:create_card' column.pk %}" class="create-card-form">
            {% csrf_token %}
            <input name="title" placeholder="Título do cartão" class="input" required />
            <input type="hidden" name="position" value="{{ column.cards.count }}" />
            <button type="submit" class="btn small">+ Novo cartão</button>
          </form>
        </div>
      {% empty %}
        <p class="empty-columns">Sem colunas ainda.</p>
      {% endfor %}

      <!-- Adicionar coluna -->
      <div class="kanban-column new-column">
        <h3>+ Adicionar coluna</h3>
        <form method="post" action="{% url 'boards:create_column' board.pk %}" class="create-column-form">
          {% csrf_token %}
          <input name="title" placeholder="Título da coluna" class="input" required />
          <input type="hidden" name="position" value="{{ board.columns.count }}" />
          <button type="submit" class="btn small">Adicionar</button>
        </form>
      </div>
    </div>
  </section>
</div>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie("csrftoken");

  document.querySelectorAll(".toggle-done").forEach((checkbox) => {
    checkbox.addEventListener("change", async (e) => {
      const li = e.target.closest("li.card");
      const cardId = li.dataset.cardId;
      try {
        const resp = await fetch(
          `{% url 'boards:toggle_card_done' 0 %}`.replace("/0/", `/${cardId}/`),
          {
            method: "POST",
            headers: {
              "X-CSRFToken": csrftoken,
              Accept: "application/json",
            },
          }
        );
        const data = await resp.json();
        if (data.is_done) {
          li.classList.add("done");
        } else {
          li.classList.remove("done");
        }
      } catch (err) {
        console.error("Erro toggle card:", err);
      }
    });
  });
</script>
{% endblock %}
