{% extends "boards/base.html" %}

{% block content %}
<div class="page">
    <div class="header">
            <div style="display:flex;align-items:center;gap:16px;flex:1;">
                <h1 class="page-title">Meus Quadros</h1>
                <form method="get" class="board-search" style="margin-left:8px;">
                    <input name="q" type="search" class="search-input" placeholder="Procurar quadros..." value="{{ request.GET.q }}">
                </form>
            </div>
            <a href="{% url 'boards:create_board' %}" class="btn-primary btn-new">+ Novo quadro</a>
    </div>

    {% if boards %}
            <div class="boards-grid">
                    {% for board in boards %}
                    <div class="board-card">
                        <h2>{{ board.title }}</h2>
                        {% if board.description %}
                            <p class="board-desc">{{ board.description|truncatechars:120 }}</p>
                        {% endif %}
                        <div class="board-meta">{{ board.created_at|date:"d/m/Y" }}</div>
                        <div class="board-actions" style="display:flex;gap:8px;margin-top:12px;">
                            <a class="btn-secondary btn-open" href="{% url 'boards:detail' board.pk %}">Abrir quadro</a>
                            <form method="post" action="{% url 'boards:delete_board' board.pk %}" onsubmit="return confirm('Deseja realmente excluir este quadro?');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger btn-open">Excluir quadro</button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
            </div>
    {% else %}
            {% if request.GET.q %}
                <div class="empty-result">
                    <h3>Nenhum quadro encontrado</h3>
                    <p>Não foi encontrado nenhum quadro para "<strong>{{ request.GET.q|escape }}</strong>".</p>
                    <p>Tente outro termo ou clique no campo de busca e pressione <kbd>Esc</kbd> ou no botão <em>X</em> para limpar e voltar à lista completa.</p>
                </div>
            {% else %}
                <p class="empty-text">Você ainda não possui quadros cadastrados.</p>
            {% endif %}
    {% endif %}
</div>
{% endblock %}

<script>
document.addEventListener('DOMContentLoaded', function () {
    const input = document.querySelector('.search-input');
    if (!input) return;

    const DEBOUNCE_MS = 250;
    let timer = null;

    function buildUrl(q) {
        const base = window.location.pathname;
        if (!q) return base;
        return base + '?q=' + encodeURIComponent(q);
    }

    const form = input.closest('form');
    function goToQuery(q) {
        // Preferir submeter o formulário (GET) para manter comportamento consistente.
        if (form) {
            // se q estiver vazio, limpar o campo e submeter para a URL base
            input.value = q || '';
            try { form.submit(); return; } catch (e) { /* fallback to assign */ }
        }
        const url = buildUrl(q);
        window.location.assign(url);
    }

    let prevVal = input.value || '';
    input.addEventListener('input', function () {
        const cur = input.value || '';
        // Se ficou vazio (usuário clicou no X ou limpou), navegar imediatamente para a URL base
        if (prevVal.length > 0 && cur.length === 0) {
            goToQuery('');
            prevVal = cur;
            return;
        }

        clearTimeout(timer);
        timer = setTimeout(() => {
            const v = cur.trim();
            // Navegar apenas se o valor não estiver vazio
            goToQuery(v);
        }, DEBOUNCE_MS);

        prevVal = cur;
    });

    // Alguns navegadores disparam o evento 'search' quando o X nativo é usado — tratar explicitamente
    input.addEventListener('search', function () {
        if ((input.value || '').length === 0) {
            goToQuery('');
        }
    });

    // ESC para limpar imediatamente
    input.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            input.value = '';
            goToQuery('');
        }
    });
});
</script>
