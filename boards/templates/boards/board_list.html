{% extends "boards/base.html" %}

{% block content %}
<div class="page">
    <div class="header">
            <div style="display:flex;align-items:center;gap:16px;flex:1;">
                <h1 class="page-title">Meus Quadros</h1>
                <form class="board-search" style="margin-left:8px;">
                    <input name="q" type="search" class="search-input" placeholder="Procurar quadros..." >
                </form>
            </div>
            <a href="{% url 'boards:create_board' %}" class="btn-primary btn-new">+ Novo quadro</a>
    </div>

    {% if boards %}
            <div class="boards-grid">
                    {% for board in boards %}
                    <div class="board-card">
                        <h2>{{ board.title }}</h2>
                        {% if board.description %}
                            <p class="board-desc">{{ board.description|truncatechars:120 }}</p>
                        {% endif %}
                        <div class="board-meta">{{ board.created_at|date:"d/m/Y" }}</div>
                        <div class="board-actions" style="display:flex;gap:8px;margin-top:12px;">
                            <a class="btn-secondary btn-open" href="{% url 'boards:detail' board.pk %}">Abrir quadro</a>
                            <form method="post" action="{% url 'boards:delete_board' board.pk %}" onsubmit="return confirm('Deseja realmente excluir este quadro?');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger btn-open">Excluir quadro</button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
            </div>
    {% else %}
            {% if request.GET.q %}
                <div class="empty-result">
                    <h3>Nenhum quadro encontrado</h3>
                    <p>Não foi encontrado nenhum quadro para "<strong>{{ request.GET.q|escape }}</strong>".</p>
                    <p>Tente outro termo ou clique no campo de busca e pressione <kbd>Esc</kbd> ou no botão <em>X</em> para limpar e voltar à lista completa.</p>
                </div>
            {% else %}
                <p class="empty-text">Você ainda não possui quadros cadastrados.</p>
            {% endif %}
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const input = document.querySelector('.search-input');
  const cards = document.querySelectorAll('.board-card');

  if (!input || !cards.length) return;

  function normalize(text) {
    return text
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '');
  }

  function highlightText(element, query) {
    const original = element.dataset.original ?? element.textContent;
    element.dataset.original = original;

    if (!query) {
      element.innerHTML = original;
      return;
    }

    const regex = new RegExp(`(${query})`, 'gi');
    element.innerHTML = original.replace(regex, '<span class="highlight">$1</span>');
  }

  function filterBoards(value) {
    const search = normalize(value);

    cards.forEach(card => {
      const title = card.querySelector('h2');
      const desc  = card.querySelector('.board-desc');

      const text = normalize(card.innerText);
      const visible = text.includes(search);

      card.style.display = visible ? '' : 'none';

      if (visible) {
        if (title) highlightText(title, value);
        if (desc)  highlightText(desc, value);
      } else {
        if (title && title.dataset.original) title.innerHTML = title.dataset.original;
        if (desc && desc.dataset.original)  desc.innerHTML = desc.dataset.original;
      }
    });
  }

  input.addEventListener('input', () => {
    filterBoards(input.value.trim());
  });

  input.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      input.value = '';
      filterBoards('');
    }
  });

  input.addEventListener('search', () => {
    if (!input.value) {
      filterBoards('');
    }
  });
});
</script>
{% endblock %}

